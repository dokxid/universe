services:
  app-production:
    container_name: universe-production
    restart: always
    env_file:
      - path: .env.production
        required: true
    environment:
      - DOCKER=1
      - HUSKY=0
      # nextjs related fields
      - NEXT_PUBLIC_USE_UNOPTIMIZED_IMAGES=false
      # postgres related fields
      - POSTGRES_HOST=postgres-production:5432
      - POSTGRES_DB=universe-production
      # betterauth related fields
      # email related fields
      - EMAIL_MODE=email
      # garage related fields
      - AWS_REGION=garage
      - AWS_BUCKET_NAME=universe-production
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./.env.production:/app/.env
    ports:
      - "3005:3000"
    networks:
      - app-network-production
    depends_on:
      - db-production
      - garage

  app-staging:
    container_name: universe-staging
    restart: always
    env_file:
      - path: .env.staging
        required: true
    environment:
      - DOCKER=1
      - HUSKY=0
      # nextjs related fields
      - NEXT_PUBLIC_USE_UNOPTIMIZED_IMAGES=false
      # postgres related fields
      - POSTGRES_HOST=postgres-staging:5432
      - POSTGRES_DB=universe-staging
      # betterauth related fields
      # email related fields
      - EMAIL_MODE=email
      # garage related fields
      - AWS_REGION=garage
      - AWS_BUCKET_NAME=universe-staging
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./.env.staging:/app/.env
    ports:
      - "3004:3000"
    networks:
      - app-network-staging
    depends_on:
      - db-staging
      - garage

  db-production:
    image: postgres
    container_name: postgres-production
    restart: always
    env_file:
      - path: .env.production
        required: true
    environment:
      - POSTGRES_DB=universe-production
    ports:
      - "5434:5432"
    volumes:
      - pgdata-production:/var/lib/postgresql
    networks:
      - app-network-production

  db-staging:
    image: postgres
    container_name: postgres-staging
    restart: always
    env_file:
      - path: .env.staging
        required: true
    environment:
      - POSTGRES_DB=universe-staging
    ports:
      - "5433:5432"
    volumes:
      - pgdata-staging:/var/lib/postgresql
    networks:
      - app-network-staging

  db-local:
    image: postgres
    container_name: postgres-local
    restart: always
    env_file:
      - path: .env
        required: true
    environment:
      - POSTGRES_DB=universe-local
    ports:
      - "5432:5432"
    volumes:
      - pgdata-local:/var/lib/postgresql
    networks:
      - app-network-local

  garage:
    container_name: garage
    image: dxflrs/garage:v2.1.0
    ports:
      - "3900:3900"
    networks:
      - app-network-production
      - app-network-staging
      - app-network-local
    restart: unless-stopped
    volumes:
      - ./garage/garage.toml:/etc/garage.toml
      - ./garage/meta:/var/lib/garage/meta
      - ./garage/data:/var/lib/garage/data

volumes:
  pgdata-production:
  pgdata-staging:
  pgdata-local:

networks:
  app-network-production:
    driver: bridge
  app-network-staging:
    driver: bridge
  app-network-local:
    driver: bridge
